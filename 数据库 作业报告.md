# 数据库 作业报告

李奕杉 闵安娜 李乐程



### 基本功能

#### 元数据模块

假设有一个数据库test被创建，其元数据会按照以下结构进行存储：

```
└── thssdb
    └── data
        ├── manager.script
        └── test
            └── test.script
```

其中`manager.script`存储所有数据库的创建纪录，每个数据库有各自的`.script`档案，存储表的创建纪录。每次启动时会读取`manager.script`，将存在的数据库写入内存并递归读取该数据库的`.script`档案，写入被纪录的表。

每次进行元数操作，系统都会立即触发更新。



#### 存储模块

#### 查询模块

#### 并发控制模块

每一个客户端有一个独立的lockManager，用于纪录用户在操作过程中使用过的锁，以及纪录用户的隔离级别。

目前数据库对象没有锁。

每一个表对象都有一个读写锁。多个用户对同一个表进行读/写操作时，会向同一个表对象申请锁，若申请失败会进入阻塞等待直到取得锁。考虑到进一步对元组设锁并不易管理，而对表设锁虽然效率低但能保障一致性。

本模块共实现两种隔离级别，`serializable`和`read committed`。当用户处于`serializable`模式时，读锁和写锁都只会在事务结束时才释放。当用户处于`serializable`模式时，写锁只会在事务结束时才释放，而读锁会在提取资料后随即释放。

当用户输入`commit`指令或者只输入单句SQL语句(auto commit)，系统响应后会遍历已纪录的读写锁，若有持有的锁就释放，最后清空锁表等待下一次事务操作。

Java提供的`ReentrantReadWriteLock`不支持锁升级，因此持有读锁而要申请写锁时需要首先释放读锁。这导致了锁被中途抢占的风险，但测试时未遇到相应情况，也没有解决方法。



#### wal模块